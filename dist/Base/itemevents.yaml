# Events for the item randomizer.
NewEvents:
  common:
  - Comment: |
      Hacky Greirat Lothric Castle softlock fix. If you don't have Grand Archives key yet, mark him
      as having talked about looting Lothric (74000308) so the actual looting flag (74000309) isn't
      touched by ESD.
    Commands:
    - EndIfEventFlag(EventEndType.End, ON, TargetEventFlagType.EventIDSlotNumber, 0)
    - EndIfEventFlag(EventEndType.End, ON, TargetEventFlagType.EventFlag, 74000309)
    - SetEventFlag(74000308, ON)
    - IfPlayerHasdoesntHaveItem(MAIN, ItemType.Goods, 2014, OwnershipState.Owns)
    - SetEventFlag(74000308, OFF)

  - Name: showLudlethItems
    Comment: Make a boss soul trigger the event to show its items in the shop.
    # Run this everywhere, not just in Firelink, so that items still show up if the player cracks the
    # soul before visiting Ludleth.
    Arguments:
    # The event flag used in ShopLineupParam to gate whether or not an item is displayed.  
    - qwcID
    # The goods ID of the boss soul
    - itemID
    Commands:
    - END IF Event Flag (EventEndType.End, ON, TargetEventFlagType.EventFlag, qwcID)
    - IF Player Has/Doesn't Have Item (MAIN, ItemType.Goods, itemID, OwnershipState.Owns)
    - Set Event Flag (qwcID, ON)

  - Name: pathOfTheDragon
    Comment: |
      Do the Path of the Dragon swap.
      We can't just use the item all of the time, since it would appear as a double drop.
    If: "!archipelago"
    Arguments: [dragonFlag]
    Commands:
    - END IF Event Flag (0,1,0,6079)
    - IF Event Flag (0,1,0,dragonFlag)
    - Award Gesture Item (29,3,9030)
    - Set Event Flag (6079,1)

  - Name: pathOfTheDragonArchi
    Comment: |
      Archipelago handles Path of the Dragon as a synthetic item or (when getting it from another
      world or a /send command) manually triggering the event 100001312.
    If: archipelago
    Arguments:
    # The ID of the local Path of the Dragon item, or -1 if it's foreign.
    - itemID
    Commands:
    - END IF Player Has/Doesn't Have Item (OR_01, ItemType.Goods, 9030, OwnershipState.Owns)
    - IF Event Flag (OR_01, ON, TargetEventFlagType.EventFlag, 100001312)
    - SKIP IF Comparison (1, ComparisonType.Equal, itemID, -1)
    - IF Player Has/Doesn't Have Item (OR_01, ItemType.Goods, itemID, OwnershipState.Owns)
    - IfConditionGroup(MAIN, PASS, OR_01)
    - Award Gesture Item (29, ItemType.Goods, 9030)
    - Set Event Flag (100001312,0)

  - Comment: |
      Another Archipelago-specific event that display a message with a special IDs that the mod can
      override to show its own messages.
    If: archipelago
    Commands:
    - IF Event Flag (0, ON, TargetEventFlagType.EventFlag, 100001313)
    - Display Message (100001312, 1)
    - Set Event Flag (100001313, OFF)

  - Comment:
      Trigger Greirat returning from Undead Settlement after beating Crystal Sage or Abyss Watchers.
    If: safequest
    Commands:
    # If Greirat has been sent to the Settlment
    - IF Event Flag (AND_01, ON, TargetEventFlagType.EventFlag, 74000303)
    # And if Crystal Sage or Abyss Watchers are defeated
    - IF Event Flag (OR_01, ON, TargetEventFlagType.EventFlag, 13300850)
    - IF Event Flag (OR_01, ON, TargetEventFlagType.EventFlag, 13300800)
    - IfConditionGroup(AND_01, PASS, OR_01)
    - IfConditionGroup(MAIN, PASS, AND_01)
    # Return Greirat to Firelink
    - Set Event Flag (74000316, ON)

  - Comment:
      Trigger Greirat returning from Irithyll after beating Pontiff or Yhorm.
    If: safequest
    Commands:
    # If Greirat has been sent to Irithyll
    - IF Event Flag (AND_01, ON, TargetEventFlagType.EventFlag, 74000306)
    # And if Pontiff or Yhorm are defeated
    - IF Event Flag (OR_01, ON, TargetEventFlagType.EventFlag, 13700850)
    - IF Event Flag (OR_01, ON, TargetEventFlagType.EventFlag, 13900800)
    - IfConditionGroup(AND_01, PASS, OR_01)
    - IfConditionGroup(MAIN, PASS, AND_01)
    # Return Greirat to Firelink
    - Set Event Flag (74000318, ON)

  m33_00_00_00: # Road of Sacrifices / Farron Keep
  - Comment: Make Anri and Horace invincible
    If: safequest
    Commands:
    - SetCharacterInvincibility(3300705, Enabled)
    - SetCharacterInvincibility(3300710, Enabled)
    - SetCharacterInvincibility(3300715, Enabled)

  m40_00_00_00: # Firelink
  - Comment: |
      Make Firelink Shrine greyed out without having the Coiled Sword, in combination with setting
      ActionButtonParam in PermutationWriter.
    Rest: Restart
    Commands:
    - Set Event Flag (14005108,1)
    - IF Player Has/Doesn't Have Item (0,3,2137,1)
    - Set Event Flag (14005108,0)

  - Comment: |
      Make Irina invincible as long as she doesn't have both light tomes. We do want her killable
      eventually so the player can get her drop. We don't need to worry about the dark tomes here
      since we edit the ESD to make her unable to take them.
    If: safequest
    Commands:
    - SetCharacterInvincibility(4000725, Enabled)
    - IfBatchEventFlags(0, LogicalOperationType.AllON, TargetEventFlagType.EventFlag, 70000350, 70000351)
    - SetCharacterInvincibility(4000725, Disabled)
    
  - Comment: |
      Make Cornyx invincible as long as he doesn't have all three pyromancy tomes. We do want him
      killable eventually so the player can get his drops.
    If: safequest
    Commands:
    - SetCharacterInvincibility(4000735, Enabled)
    - IfBatchEventFlags(0, LogicalOperationType.AllON, TargetEventFlagType.EventFlag, 70000250, 70000252)
    - SetCharacterInvincibility(4000735, Disabled)

  - Comment: Make Anri and Horace invincible
    If: safequest
    Commands:
    - SetCharacterInvincibility(4000765, Enabled)
    - SetCharacterInvincibility(4000770, Enabled)
    - SetCharacterInvincibility(4000775, Enabled)

  - Comment: |
      Make Yuria invincible until after you've married Anri, at which point you can kill her for her
      drops. We can't put this in Yuria's main event because it depends on flags set by that event.
    If: safequest
    Commands:
    - SetCharacterInvincibility(4000750, Enabled)
    - IfEventFlag(0, ON, TargetEventFlagType.EventFlag, 1042)
    - SetCharacterInvincibility(4000750, Disabled)

ExistingEvents:
  common_func:
  # Disable the event that hides treasures outside of NG+
  - ID: 20005523
    If: ngplusrings
    Edits: [AddBefore: ["GOTO Unconditionally (0)"]]
    
  common:
  - ID: 0
    If: safequest
    Edits:
    # In vanilla, Greirat  returns from each quest after you defeat any boss. This is hard to
    # factor into randomizer logic, though, because you may start the quest at a point where
    # it's difficult to find and defeat another boss. This removes the initializer that triggers
    # the "return from Settlement" and "return from Irithyll" events after boss defeats, and
    # above we add different triggers.
    - Match: {Init: {Callee: 9120}, Arguments: [74000303]}
      MatchLength: 2
      Remove: first

  # Unconditionally set the event that causes Cornyx and Orbeck to give the Pyromancy Flame and
  # Young Dragon Ring even if you're a Pyromancer or Sorcerer, respectively. Usually this is only
  # set in NG+ and beyond.
  - ID: 700
    If: safequest
    Edits:
    - Match: "EndIfEventFlag(EventEndType.End, ON, TargetEventFlagType.EventIDSlotNumber, 0)"
      AddAfter: ["SetEventFlag(70000900, ON)"]
  
  # Grand Archives Key softlock fix
  - ID: 710
    Edits:
    - Match: "EndIfConditionGroupStateUncompiled(EventEndType.End, PASS, AND_15)"
      Remove: First

  # This is the event that sets Anri's gender.
  - ID: 9012
    If: anrisamegender
    Edits:
    - Match: IfPlayerGender(MAIN, Gender.Male)
      MatchLength: 4
      Replace:
      - IfPlayerGender(MAIN, Gender.Female)
      - SetNetworkconnectedEventFlag(9013, ON)
      - IfPlayerGender(MAIN, Gender.Male)
      - SetNetworkconnectedEventFlag(9013, OFF)
  - ID: 9012
    If: anrimale
    Edits:
    - Match: IfPlayerGender(MAIN, Gender.Male)
      MatchLength: 5
      Replace:
      - SetNetworkconnectedEventFlag(9013, OFF)
  - ID: 9012
    If: anrifemale
    Edits:
    - Match: IfPlayerGender(MAIN, Gender.Male)
      MatchLength: 5
      Replace:
      - SetNetworkconnectedEventFlag(9013, ON)

  m30_00_00_00: # High Wall
  - ID: 0
    If: safequest
    Edits:
    # Remove the events that make Greirat die or aggro. These shouldn't trigger because he's
    # invincible, but just in case.
    - Match: {Init: {Callee: 20006002}, Arguments: [3000700]}
      Remove: First
    - Match: {Init: {Callee: 20006000}, Arguments: [3000700]}
      Remove: First
    - Match: {Init: {Callee: 20006001}, Arguments: [3000700]}
      Remove: First

  # Make Greirat invincible
  - ID: 13005620
    If: safequest
    Edits:
    - AddBefore: ["SetCharacterInvincibility(X0_4, Enabled)"]

  m30_01_00_00: # Lothric Castle
  - ID: 0
    Edits:
    # Fix Lothric Castle Crystal Lizard so one doesn't despawn when the other one gets killed (use new event flag)
    - Match: {Init: {Callee: 20005341}, Arguments: [null, 3010311]}
      Set: {Param: {InitArg: 0}, Value: 13010594}

  m31_00_00_00: # Undead Settlement
  - ID: 0
    Edits:
    # Remove Undead Settlement birch tree, which is a duplicate pickup which makes one unavailable.
    - Match: {Init: {Callee: 20005525}, Arguments: [53100660]}
      Remove: First

  - ID: 0
    If: safequest
    Edits:
    # Remove the event that makes Irina die.
    - Match: {Init: {Callee: 20006002}, Arguments: [3100700]}
      Remove: First
    # Same with Yoel
    - Match: {Init: {Callee: 20006002}, Arguments: [3100705]}
      Remove: First
    # Same with Cornyx
    - Match: {Init: {Callee: 20006002}, Arguments: [3100710]}
      Remove: First

  - ID: 13105600
    Comment: The driver for Yoel's quest in US
    If: safequest
    Edits:
    # Make Yoel invincible
    - AddBefore: ["SetCharacterInvincibility(X0_4, Enabled)"]
    # Don't let Yoel die if you go to Irithyll before talking to him
    - Match: IfEventFlag(AND_03, ON, TargetEventFlagType.EventFlag, 138)
      Condition: false

  # Make Irina invincible
  - ID: 13105620
    If: safequest
    Edits:
    - AddBefore: ["SetCharacterInvincibility(X0_4, Enabled)"]
    
  # Make Cornyx invincible
  - ID: 13105640
    If: safequest
    Edits:
    - AddBefore: ["SetCharacterInvincibility(X0_4, Enabled)"]

  - ID: 13105171
    If: phantomhunters
    Edits:
    # Allow Hodrick to invade after Greatwood has been defeated
    - Match: EndIfEventFlag(EventEndType.End, ON, TargetEventFlagType.EventFlag, 13100800)
      Remove: First
    # Detect the Phantom Hunters covenant instead of ember status
    - Match: IfCharacterHasSpEffect(AND_01, 10000, 490, true, ComparisonType.Equal, 1)
      Replace: ["IfPlayersCovenant(AND_01, 10)"]

  m33_00_00_00: # Road of Sacrifices / Farron Keep
  - ID: 0
    If: safequest
    Edits:
    # Remove events that make Anri and Horace hostile or dead
    - Match: {Init: {Callee: 20006001}, Arguments: [null, 1356]} # Anri attacked
      Remove: All
    - Match: {Init: {Callee: 20006002}, Arguments: [null, 1358]} # Anri dead
      Remove: All
    - Match: {Init: {Callee: 20006001}, Arguments: [null, 1496]} # Horace attacked
      Remove: First
    - Match: {Init: {Callee: 20006002}, Arguments: [null, 1498]} # Horace dead
      Remove: First
    - Match: {Init: {Callee: 13300743}} # Anri hostile because Horace is dead
      Remove: All
    - Match: {Init: {Callee: 13300745}} # Horace hostile because Anri is dead
      Remove: All
    - Match: {Init: {Callee: 13300748}} # Despairing Anri dead
      Remove: All
    - Match: {Init: {Callee: 13305741}} # Anri and Horace hostile
      Remove: All

  m37_00_00_00: # Irithyll / Anor Londo
  - ID: 0
    If: safequest
    Edits:
    # Remove events that make Anri or the Pilgrim hostile or dead
    - Match: {Init: {Callee: 20006000}, Arguments: [null, 1356]} # Anri hostile
      Remove: All
    - Match: {Init: {Callee: 20006001}, Arguments: [null, 1356]} # Anri attacked
      Remove: All
    - Match: {Init: {Callee: 20006002}, Arguments: [null, 1358]} # Anri dead
      Remove: All
    - Match: {Init: {Callee: 20006002}, Arguments: [null, 1578]} # Pilgrim dead
      Remove: All

  # Prevent Greirat becoming lost from triggering here. Skip straight ahead to the point where his
  # corpse either does or doesn't spawn. (His quest should never get to the point where he creates
  # a corpse in Irithyll, but if it does we do want it to spawn.)
  - ID: 13705630
    If: safequest
    Edits:
    - AddBefore: ["GotoUnconditionally(Label.LABEL10)"]
  
  - ID: 13705640
    Comment: Basic Anri setup logic
    If: safequest
    Edits:
    # Make Anri invulnerable (male and female versions)
    - AddBefore:
      - SetCharacterInvincibility(X0_4, Enabled)
      - SetCharacterInvincibility(X4_4, Enabled)

  - ID: 13705641
    Comment: Anri and Pilgrim logic at the decision point after Pontiff is defeated
    If: safequest
    Edits:
    # By default, this event runs as soon as Anri is in the church and Pontiff is defeated. Add an
    # additional condition that checks for Yuria being in any of the states that allows the marriage
    # to proceed.
    - Match: IfEventFlag(AND_01, ON, TargetEventFlagType.EventFlag, 9313)
      AddAfter: ["IfBatchEventFlags(AND_01, LogicalOperationType.NotAllOFF, TargetEventFlagType.EventFlag, 1041, 1043)"]
    # This shouldn't trigger given the additional check we add above, but just in case, make sure
    # we don't fail the quest.
    - Match: IfBatchEventFlags(AND_03, LogicalOperationType.AllOFF, TargetEventFlagType.EventFlag, 1041, 1043)
      Condition: false

  - ID: 13700643
    Comment: |
        Anri and Pilgrim logic that triggers the moment at which Pontiff is defeated. Has a lot of
        overlap with the previous event.
    If: safequest
    # Same edits as above, essentially
    Edits:
    - Match: IfEventFlag(AND_01, ON, TargetEventFlagType.EventFlag, 9313);
      AddAfter: ["IfBatchEventFlags(AND_01, LogicalOperationType.NotAllOFF, TargetEventFlagType.EventFlag, 1041, 1043)"]
    - Match: IfBatchEventFlags(AND_05, LogicalOperationType.AllOFF, TargetEventFlagType.EventFlag, 1041, 1043)
      Condition: false
  
  - ID: 13705645
    Comment: Londor Pilgrim logic
    If: safequest
    Edits:
    # Make the pilgrim in the church and the temple, as well as its statue equivalent
    - AddBefore:
      - SetCharacterInvincibility(X0_4, Enabled)
      - SetCharacterInvincibility(X4_4, Enabled)
      - SetCharacterInvincibility(X8_4, Enabled)

  - ID: 13705650
    Comment: Yoel and Yuria logic
    If: safequest
    Edits:
    # Don't make Yoel die upon entering Catacombs (interestingly *not* Irithyll here)
    - Match: "IfEventFlag(AND_14, ON, TargetEventFlagType.EventFlag, 136)"
      Condition: false
    - Match: "IfEventFlag(AND_15, ON, TargetEventFlagType.EventFlag, 136)"
      Condition: false
    # Disable various events that fail Yuria's quest. These shouldn't be triggerable, but just in
    # case.
    - Match: IfPlayerRemainingYoelLevelCount(AND_05, ComparisonType.Greater, 0)
      Condition: false
    - Match: IfEventFlag(AND_06, ON, TargetEventFlagType.EventFlag, 1358)
      Condition: false
    - Match: IfEventFlag(AND_07, ON, TargetEventFlagType.EventFlag, 1578)
      Condition: false
    - Match: IfEventFlag(AND_08, ON, TargetEventFlagType.EventFlag, 1043)
      Condition: false

  m38_00_00_00: # Catacombs / Smouldering Lake
  - ID: 0
    If: safequest
    Edits:
    # Remove events that make Anri hostile or dead
    - Match: {Init: {Callee: 20006001}, Arguments: [null, 1356]} # Anri attacked
      Remove: All
    - Match: {Init: {Callee: 20006002}, Arguments: [null, 1358]} # Anri dead
      Remove: All

  - ID: 13805700
    Comment: The primary driver for Anri's quest. For some reason there are two of these
    If: safequest
    Edits:
    # Make Anri invincible (male/female, in catacombs/by bridge)
    - AddBefore:
      - SetCharacterInvincibility(X0_4, Enabled)
      - SetCharacterInvincibility(X4_4, Enabled)
      - SetCharacterInvincibility(X8_4, Enabled)
      - SetCharacterInvincibility(X12_4, Enabled)
    # Don't let Anri get killed by Horace
    - Match: IfEventFlag(AND_04, ON, TargetEventFlagType.EventFlag, 1497)
      Condition: false
    # Allow Anri to move to the church even if they know where Horace is
    - Match: IfEventFlag(AND_06, OFF, TargetEventFlagType.EventFlag, 73800102)
      Remove: First

  - ID: 13805703
    Comment: The *second* primary driver for Anri's quest
    If: safequest
    Edits:
    # Same edits as above
    - Match: IfEventFlag(AND_05, OFF, TargetEventFlagType.EventFlag, 1498)
      Condition: false
    - Match: IfEventFlag(AND_07, OFF, TargetEventFlagType.EventFlag, 73800102)
      Remove: First

  - ID: 13805707
    Comment: Yuria logic
    If: safequest
    Edits:
    # Disable various events that fail Yuria's quest. These shouldn't be triggerable, but just in
    # case.
    - Match: IfPlayerRemainingYoelLevelCount(AND_05, ComparisonType.Greater, 0)
      Condition: false
    - Match: IfEventFlag(AND_06, ON, TargetEventFlagType.EventFlag, 1358)
      Condition: false
    - Match: IfEventFlag(AND_07, ON, TargetEventFlagType.EventFlag, 1578)
      Condition: false
    - Match: IfEventFlag(AND_08, ON, TargetEventFlagType.EventFlag, 1043)
      Condition: false

  m39_00_00_00: # Profaned Capitol
  # Prevent Storm Ruler infinite shiny from appearing, since it's randomized elsewhere
  - ID: 13905870
    Edits:
    - Match: "SetObjectTreasureState(X0_4, Disabled)"
      AddAfter: ["EndUnconditionally(EventEndType.End)"]

  m40_00_00_00: # Firelink
  - ID: 0
    If: safequest
    Edits:
    # Remove the events that make Greirat die or aggro. These shouldn't trigger because he's
    # invincible, but just in case.
    - Match: {Init: {Callee: 20006002}, Arguments: [4000720]}
      Remove: First
    - Match: {Init: {Callee: 20006000}, Arguments: [4000720]}
      Remove: First
    - Match: {Init: {Callee: 20006001}, Arguments: [4000720]}
      Remove: First
    # Same with Yoel
    - Match: {Init: {Callee: 20006002}, Arguments: [null, 1078]}
      Remove: First
    # Remove events that make Anri and Horace hostile or dead
    - Match: {Init: {Callee: 20006001}, Arguments: [null, 1356]} # Anri attacked
      Remove: All
    - Match: {Init: {Callee: 20006002}, Arguments: [null, 1358]} # Anri dead
      Remove: All
    - Match: {Init: {Callee: 20006001}, Arguments: [null, 1496]} # Horace attacked
      Remove: First
    - Match: {Init: {Callee: 20006002}, Arguments: [null, 1498]} # Horace dead
      Remove: First
    - Match: {Init: {Callee: 14005581}} # Anri and Horace hostile
      Remove: All
    - Match: {Init: {Callee: 14000583}} # Anri hostile because Horace is dead
      Remove: All
    - Match: {Init: {Callee: 14000585}} # Horace hostile because Anri is dead
      Remove: All
    - Match: {Init: {Callee: 14005587}} # Despairing Anri dead
      Remove: All

  - ID: 14005520
    Comment: Yuria logic
    If: safequest
    Edits:
    # Disable various events that fail Yuria's quest. These shouldn't be triggerable, but just in
    # case.
    - Match: IfPlayerRemainingYoelLevelCount(AND_05, ComparisonType.Greater, 0)
      Condition: false
    - Match: IfEventFlag(AND_06, ON, TargetEventFlagType.EventFlag, 1358)
      Condition: false
    - Match: IfEventFlag(AND_07, ON, TargetEventFlagType.EventFlag, 1578)
      Condition: false
    - Match: IfEventFlag(AND_08, ON, TargetEventFlagType.EventFlag, 1043)
      Condition: false

  - ID: 14005740
    Comment: The primary driver for Yoel's quest
    If: safequest
    Edits:
    # Make Yoel invincible
    - AddBefore: ["SetCharacterInvincibility(X0_4, Enabled)"]
    # Don't let Yoel die if you go to Irithyll before talking to him
    - Match: IfEventFlag(AND_04, ON, TargetEventFlagType.EventFlag, 138)
      Condition: false
    - Match: IfEventFlag(AND_05, ON, TargetEventFlagType.EventFlag, 138)
      Condition: false

  - ID: 14005700
    Comment: The primary driver event for Greirat's quest
    If: safequest
    Edits:
    # Prevent the player from killing Greirat
    - AddBefore: ["SetCharacterInvincibility(X0_4, Enabled)"]
    # Don't die in Irithyll if Siegward/Patches haven't saved him by making the check condition
    # always fail.
    - Match: "IfEventFlag(AND_05, OFF, TargetEventFlagType.EventFlag, 1385)"
      Condition: false
    # Don't require either Siegward or Patches to come back from Irithyll by removing those
    # conditions.
    # TODO: Consider requiring Siegward to save him, and making that unfailable
    - Match: "IfEventFlag(OR_01, ON, TargetEventFlagType.EventFlag, 1385)"
      MatchLength: 3
      Remove: First
