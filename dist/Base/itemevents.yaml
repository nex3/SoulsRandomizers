# Events for the item randomizer.
NewEvents:
  common:
  - Comment: |
      Hacky Greirat Lothric Castle softlock fix. If you don't have Grand Archives key yet, mark him
      as having talked about looting Lothric (74000308) so the actual looting flag (74000309) isn't
      touched by ESD.
    Commands:
    - EndIfEventFlag(EventEndType.End, ON, TargetEventFlagType.EventIDSlotNumber, 0)
    - EndIfEventFlag(EventEndType.End, ON, TargetEventFlagType.EventFlag, 74000309)
    - SetEventFlag(74000308, ON)
    - IfPlayerHasdoesntHaveItem(MAIN, ItemType.Goods, 2014, OwnershipState.Owns)
    - SetEventFlag(74000308, OFF)

  - Name: showLudlethItems
    Comment: Make a boss soul trigger the event to show its items in the shop.
    # Run this everywhere, not just in Firelink, so that items still show up if the player cracks the
    # soul before visiting Ludleth.
    Arguments:
    # The event flag used in ShopLineupParam to gate whether or not an item is displayed.  
    - qwcID
    # The goods ID of the boss soul
    - itemID
    Commands:
    - END IF Event Flag (EventEndType.End, ON, TargetEventFlagType.EventFlag, qwcID)
    - IF Player Has/Doesn't Have Item (MAIN, ItemType.Goods, itemID, OwnershipState.Owns)
    - Set Event Flag (qwcID, ON)

  - Name: pathOfTheDragon
    Comment: |
      Do the Path of the Dragon swap.
      We can't just use the item all of the time, since it would appear as a double drop.
    If: "!archipelago"
    Arguments: [dragonFlag]
    Commands:
    - END IF Event Flag (0,1,0,6079)
    - IF Event Flag (0,1,0,dragonFlag)
    - Award Gesture Item (29,3,9030)
    - Set Event Flag (6079,1)

  - Name: pathOfTheDragonArchi
    Comment: |
      Archipelago handles Path of the Dragon as a synthetic item or (when getting it from another
      world or a /send command) manually triggering the event 100001312.
    If: archipelago
    Arguments:
    # The unique event ID we use to track whether the gesture has been granted.  
    - trackingEvent
    # The ID of the local Path of the Dragon item, or -1 if it's foreign.
    - itemID
    Commands:
    - END IF Event Flag (EventEndType.End, ON, TargetEventFlagType.EventFlag, trackingEvent)
    - IF Event Flag (OR_01, ON, TargetEventFlagType.EventFlag, 100001312)
    - SKIP IF Comparison (1, ComparisonType.Equal, itemID, -1)
    - IF Player Has/Doesn't Have Item (OR_01, ItemType.Goods, itemID, OwnershipState.Owns)
    - IfConditionGroup(MAIN, PASS, OR_01)
    - Award Gesture Item (29,3,9030)
    - Set Event Flag (trackingEvent, 1)
    - Set Event Flag (100001312,0)

  - Comment: |
      Another Archipelago-specific event that display a message with a special IDs that the mod can
      override to show its own messages.
    If: archipelago
    Commands:
    - IF Event Flag (0, ON, TargetEventFlagType.EventFlag, 100001313)
    - Display Message (100001312, 1)
    - Set Event Flag (100001313, OFF)

  - Comment:
      Trigger Greirat returning from Undead Settlement after beating Crystal Sage or Abyss Watchers.
    If: safequest
    Commands:
    # If Greirat has been sent to the Settlment
    - IF Event Flag (AND_01, ON, TargetEventFlagType.EventFlag, 74000303)
    # And if Crystal Sage or Abyss Watchers are defeated
    - IF Event Flag (OR_01, ON, TargetEventFlagType.EventFlag, 13300850)
    - IF Event Flag (OR_01, ON, TargetEventFlagType.EventFlag, 13300800)
    - IfConditionGroup(AND_01, PASS, OR_01)
    - IfConditionGroup(MAIN, PASS, AND_01)
    # Return Greirat to Firelink
    - Set Event Flag (74000316, ON)

  - Comment:
      Trigger Greirat returning from Irithyll after beating Pontiff or Yhorm.
    If: safequest
    Commands:
    # If Greirat has been sent to Irithyll
    - IF Event Flag (AND_01, ON, TargetEventFlagType.EventFlag, 74000306)
    # And if Pontiff or Yhorm are defeated
    - IF Event Flag (OR_01, ON, TargetEventFlagType.EventFlag, 13700850)
    - IF Event Flag (OR_01, ON, TargetEventFlagType.EventFlag, 13900800)
    - IfConditionGroup(AND_01, PASS, OR_01)
    - IfConditionGroup(MAIN, PASS, AND_01)
    # Return Greirat to Firelink
    - Set Event Flag (74000318, ON)

  m40_00_00_00: # Firelink
  - Comment: |
      Make Firelink Shrine greyed out without having the Coiled Sword, in combination with setting
      ActionButtonParam in PermutationWriter.
    Rest: Restart
    Commands:
    - Set Event Flag (14005108,1)
    - IF Player Has/Doesn't Have Item (0,3,2137,1)
    - Set Event Flag (14005108,0)

ExistingEvents:
  common_func:
  # Disable the event that hides treasures outside of NG+
  - ID: 20005523
    If: ngplusrings
    Edits: [AddBefore: ["GOTO Unconditionally (0)"]]
    
  common:
  - ID: 0
    If: safequest
    Edits:
    # In vanilla, Greirat  returns from each quest after you defeat any boss. This is hard to
    # factor into randomizer logic, though, because you may start the quest at a point where
    # it's difficult to find and defeat another boss. This removes the initializer that triggers
    # the "return from Settlement" and "return from Irithyll" events after boss defeats, and
    # above we add different triggers.
    - Match: {Init: {Callee: 9120, Arguments: [74000303]}}
      MatchLength: 2
      Remove: first
  
  # Grand Archives Key softlock fix
  - ID: 710
    Edits:
    - Match: "EndIfConditionGroupStateUncompiled(EventEndType.End, PASS, AND_15)"
      Remove: First
    
  m30_00_00_00: # High Wall
  - ID: 0
    If: safequest
    Edits:
    # Remove the events that make Greirat die or aggro. These shouldn't trigger because he's
    # invincible, but just in case.
    - Match: {Init: {Callee: 20006002, Arguments: [3000700]}}
      Remove: First
    - Match: {Init: {Callee: 20006000, Arguments: [3000700]}}
      Remove: First
    - Match: {Init: {Callee: 20006001, Arguments: [3000700]}}
      Remove: First

  # Make Greirat invincible
  - ID: 13005620
    If: safequest
    Edits:
    - AddBefore: ["SetCharacterInvincibility(X0_4, Enabled)"]

  m30_01_00_00: # Lothric Castle
  - ID: 0
    Edits:
    # Fix Lothric Castle Crystal Lizard so one doesn't despawn when the other one gets killed (use new event flag)
    - Match: {Init: {Callee: 20005341, Arguments: [null, 3010311]}}
      Set: {Param: {InitArg: 0}, Value: 13010594}

  m31_00_00_00: # Undead Settlement
  - ID: 0
    Edits:
    # Remove Undead Settlement birch tree, which is a duplicate pickup which makes one unavailable.
    - Match: {Init: {Callee: 20005525, Arguments: [53100660]}}
      Remove: First

  - ID: 13105171
    If: phantomhunters
    Edits:
    # Allow Hodrick to invade after Greatwood has been defeated
    - Match: EndIfEventFlag(EventEndType.End, ON, TargetEventFlagType.EventFlag, 13100800)
      Remove: First
    # Detect the Phantom Hunters covenant instead of ember status
    - Match: IfCharacterHasSpEffect(AND_01, 10000, 490, true, ComparisonType.Equal, 1)
      Replace: ["IfPlayersCovenant(AND_01, 10)"]

  m37_00_00_00: # Irithyll / Anor Londo
  # Prevent Greirat becoming lost from triggering here. Skip straight ahead to the point where his
  # corpse either does or doesn't spawn. (His quest should never get to the point where he creates
  # a corpse in Irithyll, but if it does we do want it to spawn.)
  - ID: 13705630
    Edits:
    - AddBefore: ["GotoUnconditionally(Label.LABEL10)"]

  m39_00_00_00: # Profaned Capitol
  # Prevent Storm Ruler infinite shiny from appearing, since it's randomized elsewhere
  - ID: 13905870
    Edits:
    - Match: "SetObjectTreasureState(X0_4, Disabled)"
      AddAfter: ["EndUnconditionally(EventEndType.End)"]

  m40_00_00_00: # Firelink
  - ID: 0
    If: safequest
    Edits:
    # Remove the events that make Greirat die or aggro. These shouldn't trigger because he's
    # invincible, but just in case.
    - Match: {Init: {Callee: 20006002, Arguments: [4000720]}}
      Remove: First
    - Match: {Init: {Callee: 20006000, Arguments: [4000720]}}
      Remove: First
    - Match: {Init: {Callee: 20006001, Arguments: [4000720]}}
      Remove: First

  - ID: 14005700
    Comment: The primary driver event for Greirat's quest
    If: safequest
    Edits:
    # Prevent the player from killing Greirat
    - AddBefore: ["SetCharacterInvincibility(X0_4, Enabled)"]
    # Don't die in Irithyll if Siegward/Patches haven't saved him by making the check condition
    # always fail.
    - Match: "IfEventFlag(AND_05, OFF, TargetEventFlagType.EventFlag, 1385)"
      Replace: ["IfComparison(AND_05, ComparisonType.Equal, 0, 1)"]
    # Don't require either Siegward or Patches to come back from Irithyll by removing those
    # conditions.
    # TODO: Consider requiring Siegward to save him, and making that unfailable
    - Match: "IfEventFlag(OR_01, ON, TargetEventFlagType.EventFlag, 1385)"
      MatchLength: 3
      Remove: First
